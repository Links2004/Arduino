<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>ESP8266: ota_updates</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ESP8266
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">ota_updates </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><hr/>
 <h2>title: OTA Update </h2>
<h2>Table of Contents</h2>
<ul>
<li><a href="../../#introduction">Introduction</a><ul>
<li><a href="../../#security">Security</a></li>
<li><a href="../../#safety">Safety</a></li>
<li><a href="../../#basic-requirements">Basic Requirements</a></li>
</ul>
</li>
<li><a href="../../#arduino-ide">Arduino IDE</a><ul>
<li><a href="../../#requirements">Requirements</a></li>
<li><a href="../../#application-example">Application Example</a><ul>
<li><a href="../../#classic-ota">Classic OTA</a></li>
<li><a href="../../#arduinoota">ArduinoOTA</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="../../#web-browser">Web Browser</a><ul>
<li><a href="../../#requirements-1">Requirements</a></li>
<li><a href="../../#implementation-overview">Implementation Overview</a></li>
<li><a href="../../#application-example-1">Application Example</a></li>
</ul>
</li>
<li><a href="../../#http-server">HTTP Server</a><ul>
<li><a href="../../#requirements-2">Requirements</a></li>
<li><a href="../../#arduino-code">Arduino code</a><ul>
<li><a href="../../#simple-updater">Simple updater</a></li>
<li><a href="../../#advanced-updater">Advanced updater</a></li>
</ul>
</li>
<li><a href="../../#server-request-handling">Server request handling</a><ul>
<li><a href="../../#simple-updater-1">Simple updater</a></li>
<li><a href="../../#advanced-updater-1">Advanced updater</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="../../#stream-interface">Stream Interface</a></li>
<li><a href="../../#updater-class">Updater class</a></li>
</ul>
<h2>Introduction</h2>
<p>OTA (Over the Air) update is the process of loading the firmware to ESP module using Wi-Fi connection rather that a serial port. Such functionality became extremely useful in case of limited or no physical access to the module.</p>
<p>OTA may be done using:</p>
<ul>
<li><a href="../../#arduino-ide">Arduino IDE</a></li>
<li><a href="../../#web-browser">Web Browser</a></li>
<li><a href="../../#http-server">HTTP Server</a></li>
</ul>
<p>Arduino IDE option is intended primarily for software development phase. The two other options would be more useful after deployment, to provide module with application updates manually with a web browser or automatically using a http server.</p>
<p>In any case first firmware upload have to be done over a serial port. If OTA routines are correctly implemented in a sketch, then all subsequent uploads may be done over the air.</p>
<p>There is no imposed security on OTA process from being hacked. It is up to developer to ensure that updates are allowed only from legitimate / trusted source. Once update is complete, module restarts and new code is executed. Developer should ensure that application running on module is shut down and restarted in a safe manner. Chapters below provide additional information regarding security and safety of OTA process.</p>
<h3>Security</h3>
<p>Module has to be exposed wirelessly to get it updated with a new sketch. That poses chances of module being violently hacked and loaded with some other code. To reduce likelihood of being hacked consider protecting your uploads with a password, selecting certain OTA port, etc.</p>
<p>Check functionality provided with <a href="https://github.com/esp8266/Arduino/tree/master/libraries/ArduinoOTA">ArduinoOTA</a> library that may improve security:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> setPort(uint16_t port);</div>
<div class="line"><span class="keywordtype">void</span> setHostname(<span class="keyword">const</span> <span class="keywordtype">char</span>* hostname);</div>
<div class="line"><span class="keywordtype">void</span> setPassword(<span class="keyword">const</span> <span class="keywordtype">char</span>* password);</div>
</div><!-- fragment --><p>Certain protection functionality is already built in and do not require any additional coding by developer. <a href="https://github.com/esp8266/Arduino/tree/master/libraries/ArduinoOTA">ArduinoOTA</a> and espota.py use <a href="https://en.wikipedia.org/wiki/Digest_access_authentication">Digest-MD5</a> to authenticate upload. Integrity of transferred data is verified on ESP side using <a href="https://en.wikipedia.org/wiki/MD5">MD5</a> checksum.</p>
<p>Make your own risk analysis and depending on application decide what library functions to implement. If required consider implementation of other means of protection from being hacked, e.g. exposing module for uploads only according to specific schedule, trigger OTA only be user pressing dedicated “Update” button, etc.</p>
<h3>Safety</h3>
<p>OTA process takes ESP’s resources and bandwidth during upload. Then module is restarted and a new sketch executed. Analyse and test how it affects functionality of your existing and new sketch.</p>
<p>If ESP is placed in remote location and controlling some equipment, you should put additional attention what happens if operation of this equipment is suddenly interrupted by update process. Therefore decide how to put this equipment into safe state before starting the update. For instance your module may be controlling a garden watering system in a sequence. If this sequence is not properly shut down and a water valve left open, your garden may be flooded if this valve is not closed after OTA is finished and module restarts.</p>
<p>The following functions are provided with <a href="https://github.com/esp8266/Arduino/tree/master/libraries/ArduinoOTA">ArduinoOTA</a> library and intended to handle functionality of your application during specific stages of OTA or on an OTA error:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> onStart(OTA_CALLBACK(fn));</div>
<div class="line"><span class="keywordtype">void</span> onEnd(OTA_CALLBACK(fn));</div>
<div class="line"><span class="keywordtype">void</span> onProgress(OTA_CALLBACK_PROGRESS(fn));</div>
<div class="line"><span class="keywordtype">void</span> onError(OTA_CALLBACK_ERROR (fn));</div>
</div><!-- fragment --><h3>Basic Requirements</h3>
<ul>
<li>Flash chip size is 2x the size of the sketch.</li>
</ul>
<p>The following chapters provide more details and specific methods of doing OTA.</p>
<h2>Arduino IDE</h2>
<p>Uploading modules wirelessly from Arduino IDE is intended for the following typical scenarios:</p><ul>
<li>during firmware development as a quicker alternative to loading over a serial</li>
<li>for updating small quantity of modules</li>
<li>only if modules are available on the same network as the computer with Arduino IDE</li>
</ul>
<h3>Requirements</h3>
<ul>
<li>The ESP and the computer must be connected to the same network.</li>
</ul>
<h3>Application Example</h3>
<p>Currently there are two software configurations that support OTA updates.</p>
<ul>
<li><a href="../../#classic-ota-configuration">Classic OTA</a>: Arduino IDE 1.6.5 and 1.6.5-947-g39819f0 (of July 23, 2015) or 1.6.5-1160-gef26c5f (of Sep 30, 2015) version of platform package that provides first OTA implementation, yet without support for <a href="https://github.com/esp8266/Arduino/tree/master/libraries/ArduinoOTA">ArduinoOTA</a> library. This particular configuration is easier to configure in Arduino IDE and therefore suggested for less experienced users. It soon will be depreciated once implementation below is fully released.</li>
<li><a href="../../#arduinoota-configuration">ArduinoOTA</a>: Arduino-PR-4107-BUILD-421 and latest git version of platform package that includes <a href="https://github.com/esp8266/Arduino/tree/master/libraries/ArduinoOTA">ArduinoOTA</a> library. This configuration features preliminary build of Arduino IDE and is intended for more experienced users. Please mid your step.</li>
</ul>
<p>Instructions below demonstrate how to configure both <a href="../../#classic-ota-configuration">Classic OTA</a> and <a href="../../#arduinoota-configuration">ArduinoOTA</a> using NodeMCU 1.0 (ESP-12E Module) board.</p>
<h4>Classic OTA</h4>
<ol type="1">
<li>Before you begin, please make sure that you have the following installed:<ul>
<li>Arduino IDE and ESP8266 board support as described under <a href="https://github.com/esp8266/Arduino#installing-with-boards-manager">https://github.com/esp8266/Arduino#installing-with-boards-manager</a></li>
<li><p class="startli"><a href="https://www.python.org/">Python</a> 2.7 (do not install Python 3.5 that is not supported):</p>
<p class="startli"><b>Note:</b> Windows users should select “Add python.exe to Path” (see below – this option is not selected by default).</p>
<div class="image">
<img src="../../ota-ide-python-configuration.png"  alt="Python installation set up"/>
</div>
</li>
</ul>
</li>
<li>Now prepare the sketch and configuration for the upload over a serial port.<ul>
<li>Start Arduino IDE and load sketch DNS_SD_Arduino_OTA.ino available under <a class="el" href="../../d1/d31/class_file.html">File</a> &gt; Examples &gt; ESP8266mDNS <div class="image">
<img src="../../ota-ide-sketch-selection.png"  alt="OTA sketch selection"/>
</div>
 <b>Note:</b> This sketch is available only for 1.6.5-947-g39819f0 (of July 23, 2015) and 1.6.5-1160-gef26c5f (of Sep 30, 2015) versions of platform packages installed in Arduino IDE using <a href="https://github.com/esp8266/Arduino#installing-with-boards-manager">https://github.com/esp8266/Arduino#installing-with-boards-manager</a>. It was removed in <a href="https://github.com/esp8266/Arduino/pull/980">#980</a> from GitHub repository.</li>
<li>Update ssid and pass in the sketch so the module can join your Wi-Fi network <div class="image">
<img src="../../ota-ide-ssid-pass-entry.png"  alt="ssid and pass entry"/>
</div>
</li>
<li>Configure upload parameters as below (you may need to adjust configuration if you are using a different module): <div class="image">
<img src="../../ota-ide-serial-upload-configuration.png"  alt="configuration of serial upload"/>
</div>
</li>
</ul>
</li>
<li><p class="startli">Upload the sketch (Ctrl+U). Once done open Serial Monitor (Ctrl+Shift+M) and check if module has joined your Wi-Fi network.</p>
<div class="image">
<img src="../../ota-ide-module-joined-wifi.png"  alt="check if module joined network"/>
</div>
</li>
<li><p class="startli">Only if module is connected to network, after a couple of seconds, the esp8266-ota port will show up in Arduino IDE:</p>
<div class="image">
<img src="../../ota-ide-ota-port-selection.png"  alt="selection og OTA port"/>
</div>
</li>
<li><p class="startli">Now get ready for your first OTA upload by changing configuration settings as follows:</p>
<div class="image">
<img src="../../ota-ide-ota-upload-configuration.png"  alt="configuration of OTA upload"/>
</div>
<p class="startli"><b>Note:</b> If you do not see “Upload Using: OTA” option available for “NodeMCU 1.0 (ESP-12E Module)” board, please upload the latest <a href="https://github.com/esp8266/Arduino/blob/master/boards.txt">boards.txt</a> file from GitHub repository, replace existing file and restart Arduino IDE.</p>
</li>
<li><p class="startli">If you have successfully completed all the above steps, you can upload (Ctrl+U) the same (or any other) sketch over OTA:</p>
<div class="image">
<img src="../../ota-ide-ota-upload-complete.png"  alt="OTA upload complete"/>
</div>
</li>
</ol>
<p><b>Note</b> To be able to upload your sketch over and over again using OTA, you need to embed OTA routines inside. Please use DNS_SD_Arduino_OTA.ino as an example.</p>
<h4>ArduinoOTA</h4>
<ol type="1">
<li>Upload and install the following software:<ul>
<li>Arduino-PR-4107-BUILD-421 - <a href="https://github.com/esp8266/Arduino/pull/984#issuecomment-155905800">https://github.com/esp8266/Arduino/pull/984#issuecomment-155905800</a></li>
<li>Latest git version of platform package - <a href="https://github.com/esp8266/Arduino#using-git-version-">https://github.com/esp8266/Arduino#using-git-version-</a></li>
<li>Python 2.7</li>
</ul>
</li>
<li>Proceed to step 2 under <a href="../../#classic-ota-configuration">Classic OTA Configuration</a> using BasicOTA.ino or OTALeds.ino sketch instead.</li>
<li>Carry on with remaining steps.</li>
</ol>
<h2>Web Browser</h2>
<p>Updates described in this chapter are done with a web browser that can be useful in the following typical scenarios:</p>
<ul>
<li>after application deployment if loading directly from Arduino IDE is inconvenient or not possible</li>
<li>after deployment if user is unable to expose module for OTA from external update server</li>
<li>to provide updates after deployment to small quantity of modules when setting an update server is not practicable</li>
</ul>
<h3>Requirements</h3>
<ul>
<li>The ESP and the computer must be connected to the same network.</li>
</ul>
<h3>Implementation Overview</h3>
<p>Updates with a web browswer are implemented using <code><a class="el" href="../../de/d1d/class_e_s_p8266_h_t_t_p_update_server.html">ESP8266HTTPUpdateServer</a></code> class together with <code><a class="el" href="../../d3/d58/class_e_s_p8266_web_server.html">ESP8266WebServer</a></code> and <code>ESP8266mDNS</code> classes. The following code is required to get it work:</p>
<p>setup()</p>
<div class="fragment"><div class="line">MDNS.<a class="code" href="../../d0/d6d/class_m_d_n_s_responder.html#afe4e0b409c85b508dc55be4284ade323">begin</a>(host);</div>
<div class="line"></div>
<div class="line">httpUpdater.setup(&amp;httpServer);</div>
<div class="line">httpServer.begin();</div>
<div class="line"></div>
<div class="line">MDNS.<a class="code" href="../../d0/d6d/class_m_d_n_s_responder.html#a7c637cdc8ec962d98c9dea6c35c02f2a">addService</a>(<span class="stringliteral">&quot;http&quot;</span>, <span class="stringliteral">&quot;tcp&quot;</span>, 80);</div>
</div><!-- fragment --><p>loop()</p>
<div class="fragment"><div class="line">httpServer.handleClient();</div>
</div><!-- fragment --><h3>Application Example</h3>
<p>The sample implementation provided below has been done using:</p>
<ul>
<li>example sketch WebUpdater.ino available in <a class="el" href="../../de/d1d/class_e_s_p8266_h_t_t_p_update_server.html">ESP8266HTTPUpdateServer</a> library</li>
<li>NodeMCU 1.0 (ESP-12E Module)</li>
</ul>
<p>You can use another module if it meets “Flash chip size is 2x the size of the sketch” requirement.</p>
<ol type="1">
<li>Before you begin, please make sure that you have the following software installed:<ul>
<li>Arduino IDE and 2.0.0-rc1 (of Nov 17, 2015) version of platform package as described under <a href="https://github.com/esp8266/Arduino#installing-with-boards-manager">https://github.com/esp8266/Arduino#installing-with-boards-manager</a></li>
<li>Host software depending on O/S you use:<ol type="a">
<li>Avahi <a href="http://avahi.org/">http://avahi.org/</a> for Linux</li>
<li>Bonjour <a href="http://www.apple.com/support/bonjour/">http://www.apple.com/support/bonjour/</a> for Windows</li>
<li>Mac OSX and iOS - support is already built in / no any extra s/w is required</li>
</ol>
</li>
</ul>
</li>
<li>Prepare the sketch and configuration for initial upload with a serial port.<ul>
<li>Start Arduino IDE and load sketch WebUpdater.ino available under <a class="el" href="../../d1/d31/class_file.html">File</a> &gt; Examples &gt; <a class="el" href="../../de/d1d/class_e_s_p8266_h_t_t_p_update_server.html">ESP8266HTTPUpdateServer</a>.</li>
<li>Update ssid and pass in the sketch so the module can join your Wi-Fi network.</li>
<li>Open <a class="el" href="../../d1/d31/class_file.html">File</a> &gt; Preferences, look for “Show verbose output during:” and check out “compilation” option. <div class="image">
<img src="../../ota-web-show-verbose-compilation.png"  alt="Preferences - enablig verbose output during compilation"/>
</div>
 <b>Note:</b> This setting will be required in step 5 below. You can uncheck this setting afterwards.</li>
</ul>
</li>
<li>Upload sketch (Ctrl+U). Once done open Serial Monitor (Ctrl+Shift+M) and check if you see the following message displayed, that contains url for OTA update. <div class="image">
<img src="../../ota-web-serial-monitor-ready.png"  alt="Serial Monitor - after first load using serial"/>
</div>
 <b>Note:</b> Such message will be shown only after module successfully joins network and is ready for an OTA upload:</li>
<li>Now open web browser and enter the url provided on Serial Monitor, i.e. <a href="http://esp8266-webupdate.local/update">http://esp8266-webupdate.local/update</a>. Once entered, browser should display a form like below that has been served by your module. The form invites you to choose a file for update. <div class="image">
<img src="../../ota-web-browser-form.png"  alt="OTA update form in web browser"/>
</div>
 <b>Note:</b> If entering “http://esp8266-webupdate.local/update” does not work, try replacing “esp8266-webupdate” with module’s IP address. For example, if your module IP is “192.168.1.100” then url should be “http://192.168.1.100/update”. This workaround is useful in case the host software installed in step 2 does not work. If still nothing works and there are no clues on Serial Monitor, try to diagnose issue by opening provided url in Google Chrome, pressing F12 and checking contents of “Console” and “Network” tabs. Chrome provides some advanced logging on these tabs.</li>
<li><p class="startli">To obtain the file navigate to directory used by Arduino IDE to store results of compilation. You can check the path to this file in compilation log shown in IDE debug window as marked below.</p>
<div class="image">
<img src="../../ota-web-path-to-binary.png"  alt="Compilation complete - path to binary file"/>
</div>
</li>
<li><p class="startli">Now press “Choose File” in web browser, go to directory identified in step 5 above, find the file “WebUpdater.cpp.bin” and upload it. If upload is successful you will see “OK” on web browser like below.</p>
<div class="image">
<img src="../../ota-web-browser-form-ok.png"  alt="OTA update complete"/>
</div>
<p class="startli">Module will reboot that should be visible on Serial Monitor:</p>
<div class="image">
<img src="../../ota-web-serial-monitor-reboot.png"  alt="Serial Monitor - after OTA update"/>
</div>
</li>
</ol>
<p>Just after reboot you should see exactly the same message “HTTPUpdateServer ready! Open <a href="http://">http://</a> esp8266-webupdate.local /update in your browser” like in step 3. This is because module has been loaded again with the same code – first using serial port, and then using OTA.</p>
<p>Once you are comfortable with this procedure go ahead and modify WebUpdater.ino sketch to print some additional messages, compile it, locate new binary file and upload it using web browser to see entered changes on a Serial Monitor.</p>
<p>You can also add OTA routines to your own sketch following guidelines in <a href="../../#implementation-overview">Implementation Overview</a> above. If this is done correctly you should be always able to upload new sketch over the previous one using a web browser.</p>
<p>In case OTA update fails dead after entering modifications in your sketch, you can always recover module by loading it over a serial port. Then diagnose the issue with sketch using Serial Monitor. Once the issue is fixed try OTA again.</p>
<h2>HTTP <a class="el" href="../../dc/db6/class_server.html">Server</a></h2>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;{ESPhttpUpdate```}</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;It is possible to download updates from every IP or domain address on the network or Internet.</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;#### Requirements</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160; - web server</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;#### Arduino code</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;##### Simple updater</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;Simple updater downloads the file every time the function is called.</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;```cpp</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;ESPhttpUpdate.update(&quot;192.168.0.2&quot;, 80, &quot;/arduino.bin&quot;);</div>
</div><!-- fragment --><h5>Advanced updater</h5>
<p>Its possible to point update function to a script at the server. If version string argument is given, it will be sent to the server. <a class="el" href="../../dc/db6/class_server.html">Server</a> side script can use this to check if update should be performed.</p>
<p><a class="el" href="../../dc/db6/class_server.html">Server</a> side script can respond as follows:</p><ul>
<li>response code 200, and send the firmware image,</li>
<li>or response code 304 to notify ESP that no update is required.</li>
</ul>
<div class="fragment"><div class="line">t_httpUpdate_return ret = ESPhttpUpdate.<a class="code" href="../../df/d31/class_e_s_p8266_h_t_t_p_update.html#a7cf404d8cb00212189607871e1d412b1">update</a>(<span class="stringliteral">&quot;192.168.0.2&quot;</span>, 80, <span class="stringliteral">&quot;/esp/update/arduino.php&quot;</span>, <span class="stringliteral">&quot;optional current version string here&quot;</span>);</div>
<div class="line"><span class="keywordflow">switch</span>(ret) {</div>
<div class="line">    <span class="keywordflow">case</span> HTTP_UPDATE_FAILED:</div>
<div class="line">        Serial.<a class="code" href="../../d8/d90/class_print.html#a501b3057362eecf43c0b3ae7c6f09550">println</a>(<span class="stringliteral">&quot;[update] Update failed.&quot;</span>);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> HTTP_UPDATE_NO_UPDATES:</div>
<div class="line">        Serial.<a class="code" href="../../d8/d90/class_print.html#a501b3057362eecf43c0b3ae7c6f09550">println</a>(<span class="stringliteral">&quot;[update] Update no Update.&quot;</span>);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> HTTP_UPDATE_OK:</div>
<div class="line">        Serial.<a class="code" href="../../d8/d90/class_print.html#a501b3057362eecf43c0b3ae7c6f09550">println</a>(<span class="stringliteral">&quot;[update] Update ok.&quot;</span>); <span class="comment">// may not called we reboot the ESP</span></div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">}</div>
</div><!-- fragment --><h4><a class="el" href="../../dc/db6/class_server.html">Server</a> request handling</h4>
<h5>Simple updater</h5>
<p>For the simple updater the server only needs to deliver the binary file for update.</p>
<h5>Advanced updater</h5>
<p>For advanced update management a script needs to run at the server side, for example a PHP script. At every update request the the ESP sends some information in HTTP headers to the server.</p>
<p>Example header data: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;[HTTP_USER_AGENT] =&gt; ESP8266-http-Update</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;[HTTP_X_ESP8266_STA_MAC] =&gt; 18:FE:AA:AA:AA:AA</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;[HTTP_X_ESP8266_AP_MAC] =&gt; 1A:FE:AA:AA:AA:AA</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;[HTTP_X_ESP8266_FREE_SPACE] =&gt; 671744</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;[HTTP_X_ESP8266_SKETCH_SIZE] =&gt; 373940</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;[HTTP_X_ESP8266_CHIP_SIZE] =&gt; 524288</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;[HTTP_X_ESP8266_SDK_VERSION] =&gt; 1.3.0</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;[HTTP_X_ESP8266_VERSION] =&gt; DOOR-7-g14f53a19</div>
</div><!-- fragment --><p>With this information the script now can check if a update is needed. It is also possible to deliver different binaries based on the MAC address for example.</p>
<p>Script example:</p>
<div class="fragment"><div class="line">&lt;?PHP</div>
<div class="line"></div>
<div class="line">header(<span class="stringliteral">&#39;Content-type: text/plain; charset=utf8&#39;</span>, <span class="keyword">true</span>);</div>
<div class="line"></div>
<div class="line"><span class="keyword">function</span> check_header($name, $value = <span class="keyword">false</span>) {</div>
<div class="line">    <span class="keywordflow">if</span>(!isset($_SERVER[$name])) {</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span>($value &amp;&amp; $_SERVER[$name] != $value) {</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">function</span> sendFile($path) {</div>
<div class="line">    header($_SERVER[<span class="stringliteral">&quot;SERVER_PROTOCOL&quot;</span>].<span class="stringliteral">&#39; 200 OK&#39;</span>, <span class="keyword">true</span>, 200);</div>
<div class="line">    header(<span class="stringliteral">&#39;Content-Type: application/octet-stream&#39;</span>, <span class="keyword">true</span>);</div>
<div class="line">    header(<span class="stringliteral">&#39;Content-Disposition: attachment; filename=&#39;</span>.basename($path));</div>
<div class="line">    header(<span class="stringliteral">&#39;Content-Length: &#39;</span>.filesize($path), <span class="keyword">true</span>);</div>
<div class="line">    readfile($path);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordflow">if</span>(!check_header(<span class="stringliteral">&#39;HTTP_USER_AGENT&#39;</span>, <span class="stringliteral">&#39;ESP8266-http-Update&#39;</span>)) {</div>
<div class="line">    header($_SERVER[<span class="stringliteral">&quot;SERVER_PROTOCOL&quot;</span>].<span class="stringliteral">&#39; 403 Forbidden&#39;</span>, <span class="keyword">true</span>, 403);</div>
<div class="line">    echo <span class="stringliteral">&quot;only for ESP8266 updater!\n&quot;</span>;</div>
<div class="line">    exit();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordflow">if</span>(</div>
<div class="line">    !check_header(<span class="stringliteral">&#39;HTTP_X_ESP8266_STA_MAC&#39;</span>) ||</div>
<div class="line">    !check_header(<span class="stringliteral">&#39;HTTP_X_ESP8266_AP_MAC&#39;</span>) ||</div>
<div class="line">    !check_header(<span class="stringliteral">&#39;HTTP_X_ESP8266_FREE_SPACE&#39;</span>) ||</div>
<div class="line">    !check_header(<span class="stringliteral">&#39;HTTP_X_ESP8266_SKETCH_SIZE&#39;</span>) ||</div>
<div class="line">    !check_header(<span class="stringliteral">&#39;HTTP_X_ESP8266_CHIP_SIZE&#39;</span>) ||</div>
<div class="line">    !check_header(<span class="stringliteral">&#39;HTTP_X_ESP8266_SDK_VERSION&#39;</span>) ||</div>
<div class="line">    !check_header(<span class="stringliteral">&#39;HTTP_X_ESP8266_VERSION&#39;</span>)</div>
<div class="line">) {</div>
<div class="line">    header($_SERVER[<span class="stringliteral">&quot;SERVER_PROTOCOL&quot;</span>].<span class="stringliteral">&#39; 403 Forbidden&#39;</span>, <span class="keyword">true</span>, 403);</div>
<div class="line">    echo <span class="stringliteral">&quot;only for ESP8266 updater! (header)\n&quot;</span>;</div>
<div class="line">    exit();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">$db = array(</div>
<div class="line">    <span class="stringliteral">&quot;18:FE:AA:AA:AA:AA&quot;</span> =&gt; <span class="stringliteral">&quot;DOOR-7-g14f53a19&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;18:FE:AA:AA:AA:BB&quot;</span> =&gt; <span class="stringliteral">&quot;TEMP-1.0.0&quot;</span></div>
<div class="line">);</div>
<div class="line"></div>
<div class="line"><span class="keywordflow">if</span>(isset($db[$_SERVER[<span class="stringliteral">&#39;HTTP_X_ESP8266_STA_MAC&#39;</span>]])) {</div>
<div class="line">    <span class="keywordflow">if</span>($db[$_SERVER[<span class="stringliteral">&#39;HTTP_X_ESP8266_STA_MAC&#39;</span>]] != $_SERVER[<span class="stringliteral">&#39;HTTP_X_ESP8266_VERSION&#39;</span>]) ) {</div>
<div class="line">        sendFile(<span class="stringliteral">&quot;./bin/&quot;</span>.$db[$_SERVER[<span class="stringliteral">&#39;HTTP_X_ESP8266_STA_MAC&#39;</span>]].<span class="stringliteral">&quot;bin&quot;</span>);</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        header($_SERVER[<span class="stringliteral">&quot;SERVER_PROTOCOL&quot;</span>].<span class="stringliteral">&#39; 304 Not Modified&#39;</span>, <span class="keyword">true</span>, 304);</div>
<div class="line">    }</div>
<div class="line">    exit();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">header($_SERVER[<span class="stringliteral">&quot;SERVER_PROTOCOL&quot;</span>].<span class="stringliteral">&#39; 500 no version for ESP MAC&#39;</span>, <span class="keyword">true</span>, 500);</div>
</div><!-- fragment --><h2><a class="el" href="../../d1/d51/class_stream.html">Stream</a> Interface</h2>
<p>TODO describe <a class="el" href="../../d1/d51/class_stream.html">Stream</a> Interface</p>
<p>The <a class="el" href="../../d1/d51/class_stream.html">Stream</a> Interface is the base for all other update modes like OTA, http <a class="el" href="../../dc/db6/class_server.html">Server</a> / client.</p>
<h2>Updater class</h2>
<p>TODO describe Updater class</p>
<p>Updater is in the Core and deals with writing the firmware to the flash, checking its integrity and telling the bootloader to load the new firmware on the next boot. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.10
</small></address>
</body>
</html>
